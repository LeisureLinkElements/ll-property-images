<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">

<script type="application/javascript" src="../lodash/lodash.js"></script>

<!--
An element providing a solution to no problem in particular.

Example:

    <ll-property-images-manager baseUrl="http://somewhere.com"></ll-property-images-manager>

@demo
-->
<dom-module id="ll-property-images-manager">
  <template>
    <iron-ajax id="all" url="{{_allUrl}}" handle-as="json" on-response="_handleAll"></iron-ajax>
    <iron-ajax id="add" url="{{_addUrl}}" handle-as="json" on-response="_handleAdd" method="POST" on-error="_handleAjaxError"></iron-ajax>
    <iron-ajax id="update" handle-as="json" on-response="_handleUpdate" method="PUT" on-error="_handleAjaxError"></iron-ajax>
    <iron-ajax id="delete" handle-as="text" on-response="_handleDelete" method="DELETE" on-error="_handleAjaxError"></iron-ajax>
  </template>
</dom-module>

<script>

  Polymer({

    is: 'll-property-images-manager',

    properties: {

      /**
       * The base url of the api
       */
      baseUrl: { type: String, notify: true, reflectToAttribute: true },

      /**
       * The base url of the api
       */
      unitId: { type: String, notify: true, reflectToAttribute: true },

      _allUrl: {
        type: String,
        computed: '_buildUrl(baseUrl, _language, unitId)'
      },

      _addUrl: {
        type: String,
        computed: '_buildUrl(baseUrl, _language, unitId)'
      },

      _language: { type: String, readOnly: true, value: 'en' }

    },

    ready: function() {

    },


    /**
     * The `images-received` event is fired when the images have been retrieved
     * @event image-received
     * @detail {[{ id: string, name: string, title: string, url: string, isPrimary: boolean }]}
     */

    /**
     * Retrieves the images then fires the event `images-received` event
     * @fires images-received
     */
    getImages: function() {
      var ajax = this.$.all;
      ajax.generateRequest();
    },

    /**
     * The `image-added` event is fired when an image has been added successfully
     * @event image-added
     * @detail {{ id: string, name: string, title: string, url: string, isPrimary: boolean }}
     */

    /**
     * Adds/uploads and image an image and fires the `image-added` event
     *
     * @fires image-added
     * @param {{name: string, title: string, image: fileStream, isPrimary: boolean}} image
     */
    addImage: function(image, index) {
      var ajax = this.$.add;
      var data = new FormData();

      data.append('order', (index > 0)? index + 1 : index);
      data.append('image', image.file);
      data.append('title', image.title);
      ajax.contentType = null;
      ajax.body = data;
      ajax.generateRequest();
    },
    /**
     * The `image-updated` event is fired when an image has been added successfully
     * @event image-updated
     * @detail {{ id: string, name: string, title: string, url: string, isPrimary: boolean }}
     */

    /**
     * Updates the image and fires the `image-updated` event
     *
     * @fires image-updated
     * @param {{id: string, name: string, title: string, image: fileStream, isPrimary: boolean}} image
     */
    updateImage: function(image) {
      var ajax = this.$.update;

      ajax.contentType = 'application/json';
      ajax.url = this._buildUrlWithId(this.baseUrl, this._language, image.imgId);
      ajax.body = JSON.stringify({
        title: image.title,
        description: image.description  || '',
        isPrimary: image.isPrimary,
        order: image.sortOrder,
        categories: image.tags,
        fileName: image.fileName
      });
      ajax.generateRequest();
    },

    /**
     * The `image-removed` event is fired when an image has been removed
     * @event image-removed
     * @detail {{ id: id}}
     */

    /**
     * Removes and image and fires the `image-removed` event
     * @param {string} id
     * @fires image-removed
     */
    deleteImage: function(id) {
      var ajax = this.$.delete;
      ajax.url = this._buildUrlWithId(this.baseUrl, this._language, id);
      ajax.generateRequest();
    },


    /**
     * The `image-made-primary` event is fired when an image has been set as primary successfully.
     * @event image-made-primary
     * @detail {[{ id: string, name: string, title: string, url: string, isPrimary: boolean }]}
     */

    /**
     * Makes the image the primary image, and fires the event `image-made-primary`.
     * @param {object} newPrimaryImage - the data object for the image that will be set to the primary
     * @param {object} oldPrimaryImage - the data object for the image that will be removed from the primary status
     */
    setAsPrimaryImage: function(newPrimaryImage, oldPrimaryImage) {
      oldPrimaryImage.isPrimary = false;
      this.updateImage(newPrimaryImage);
      this.updateImage(oldPrimaryImage);
      var imageData = [oldPrimaryImage, newPrimaryImage];
      this.fire('image-made-primary', imageData);
    },

    _buildUrl: function(baseUrl, language, unitId) {
      return baseUrl + 'images-api/public/v1/' + language + '/units/' + unitId + '/images';
//      return baseUrl + 'media-api/public/v1/' + language + '/units/' + unitId + '/images';
    },

    _buildUrlWithId: function(baseUrl, language, id) {
      return baseUrl+ 'images-api/public/v1/' + language + '/images/' + id;
//      return baseUrl+ 'media-api/public/v1/' + language + '/images/' + id;
    },


    _handleAll: function(e, detail) {
      this.fire('images-received', detail.response);
    },

    _handleAdd: function(e, detail) {
      this.fire('image-added', detail.response);
    },

    _handleUpdate: function(e, detail) {
      var id = _.last(detail.xhr.responseURL.split('/'));
      this.fire('image-updated', id);
    },

    _handleDelete: function(e, detail) {
      var id = _.last(detail.xhr.responseURL.split('/'));
      this.fire('image-removed', id);
    },
    _handleAjaxError: function(e, detail) {
      this.fire('image-action-failed', detail.error);
    }

  });

</script>
