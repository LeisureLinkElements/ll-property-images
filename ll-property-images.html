<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../ll-theme/ll-theme.html">
<link rel="import" href="../ll-property-image/ll-property-image.html">
<link rel="import" href="ll-property-images-manager.html">

<script type="application/javascript" src="../lodash/lodash.js"></script>

<!--
An element providing a solution to no problem in particular.

Example:

    <ll-property-images unitId="123111451"></ll-property-images>

@demo
-->
<dom-module id="ll-property-images">

  <template>
    <ll-property-images-manager id="manager" unit-id="[[unitId]]" base-url="http://localhost:3000"></ll-property-images-manager>
    <div class="row">
      <template id="item-list" is="dom-repeat" items="{{_images}}">
        <ll-property-image id="{{item.id}}" img-id="{{item.id}}" name="{{item.name}}" title="{{item.title}}" description="{{item.description}}" src="{{item.url}}" is-default-image$="{{item.isDefaultImage}}" tags="{{item.tags}}"></ll-property-image>
      </template>
    </div>
  </template>

</dom-module>

<script>

  Polymer({

    is: 'll-property-images',

    listeners: {
      'll-property-image-delete': '_imageDeleted',
      'll-property-image-default': '_defaultImageChange'
    },

    properties: {

      /**
       * The property's Id
       */
      unitId: { type: String, notify: true, value: '' },

      /**
       * The property images
       *
       * @type {[{id: string, title: string, description: string, isDefault: boolean, url: string}]}
       */
      _images: {
        type: Array,
        notify: true
      }
    },

    ready: function() {
      this.$.manager.getImages();
    },
    created: function() {
      this.toggleClass('row', true, this);
    },
    _imageDeleted: function(e) {
//      var img = _.findIndex(this._images, { id: e.detail.imgId });
//      this.splice('_images', img, 1 );
        this.$.manager.deleteImage(e.detail.imgId);
    },
    _defaultImageChange: function(e) {
      this.$.manager.setAsDefaultImage(e.detail.imgId);
    },
    getChangedImages: function() {
      //We need to get the NodeList object, convert it to an array (so we can loop)
      var _changedImages = [];
      var _imageNodeList = this.querySelectorAll('ll-property-image');

      Array.prototype.slice.call(_imageNodeList).forEach(function(image){
        if(image.isDirty()) {
          _changedImages.push(image.getChanges());
        }
      });

      console.log(_changedImages);
      return _changedImages;

    }

  });

</script>
