<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">

<link rel="import" href="../ll-theme/ll-theme.html">
<link rel="import" href="../ll-property-image/ll-property-image.html">
<link rel="import" href="ll-property-images-manager.html">
<link rel="import" href="../ll-image-uploader/ll-image-uploader.html">

<script type="application/javascript" src="../lodash/lodash.js"></script>

<!--
An element providing a solution to no problem in particular.

Example:

    <ll-property-images unitId="123111451"></ll-property-images>

@demo
-->
<dom-module id="ll-property-images">

  <style>
    .save-changes {
      padding-bottom: 15px;
      text-align: right;
      padding-right: 15px;
    }

    #confirmation {
      min-height: 170px;
    }
  </style>

  <template>

    <ll-property-images-manager id="manager" unit-id="[[unitId]]" base-url="http://images-api.ka">
    </ll-property-images-manager>
    <ll-image-uploader id="uploader" on-upload="_handleUpload"></ll-image-uploader>

    <div class="row" id="row">
      <template id="item-list" is="dom-repeat" items="{{_images}}" sort="_sort">
        <ll-property-image
          id="{{item._id}}"
          img-id="{{item._id}}"
          name="{{item.fileName}}"
          title="{{item.title}}"
          description="{{item.description}}"
          src="{{item.url}}"
          is-default$="{{item.isDefault}}"
          tags="{{item.tags}}"
          sort-order="{{item.sortOrder}}">
        </ll-property-image>
      </template>
    </div>

    <div class="row save-changes">
      <button class="btn btn-primary" on-tap="_updateChangedImages">Save Changes</button>
    </div>

    <paper-dialog id="confirmation" modal>
      <h4>Delete image?</h4>

      <div>
        Are you sure you would like to delete this image?
      </div>
      <div style="text-align: right;">
        <button class="btn btn-default" dialog-dismiss>Cancel</button>
        <button class="btn btn-destructive" dialog-confirm autofocus>Delete Image</button>
      </div>
    </paper-dialog>
  </template>

</dom-module>

<script>

  Polymer({

    is: 'll-property-images',

    listeners: {
      'll-property-image-delete': '_imageDeleted',
      'll-property-image-default': '_defaultImageChange',
      'iron-overlay-closed': '_dialogClosed',
      'll-property-image-drag': '_dragDropped',
      'images-received': '_imagesReceived',
      'image-added': '_imageAdded',
      'image-removed': '_imageRemoved',
      'image-updated': '_imageUpdated'
    },

    properties: {

      /**
       * The property's Id
       */
      unitId: { type: String, notify: true, value: '' },

      /**
       * The property images
       *
       * @type {[{_id: string, title: string, description: string, isDefault: boolean, url: string}]}
       */
      _images: {
        type: Array,
        notify: true,
        value: []
      }
    },

    ready: function() {
      this.$.manager.getImages();
      var _this = this;

      window.onbeforeunload = function() {
        var unsaved = _this.getChangedImages();
        if (unsaved.length !== 0) {
          if (unsaved.length === 1) {
            return 'There is ' + unsaved.length + ' image with unsaved changes.';
          } else {
            return 'There are ' + unsaved.length + ' images with unsaved changes.';
          }
        }
      }

    },
    /**
     * Polymer lifecycle event.
     * Adding the bootstrap row class to the root element
     */
    created: function() {
      this.toggleClass('row', true, this);
    },
    /**
     * Fired when it receives the ll-property-image-delete event
     * Will set an attribute to save the image that is being deleted
     * Will show a confirmation dialog
     * @private
     */
    _imageDeleted: function(e) {
      _itemToDelete = e.detail.imgId;
      this.$.confirmation.open();
      this.$.confirmation.setAttribute('img-id', e.detail.imgId);
    },
    /**
     * Fired when it received the ll-property-image-default event
     * Will call the manager to set the image as the default property image.
     * @private
     */
    _defaultImageChange: function(e) {
      this.$.manager.setAsDefaultImage(e.detail);
    },
    /**
     * Will iterate over all child ll-property-image tags and call isDirty and then getChanges
     * Deleting an image should happen immediately. Because of this, a delete will not show up as dirty, and will not appear in the getChanges array.
     * returns{Array}
     * @public
     */
    getChangedImages: function() {
      //We need to get the NodeList object, convert it to an array (so we can loop)
      var _imageNodeList = this.querySelectorAll('ll-property-image');

      var _changedImages = Array.prototype.slice.call(_imageNodeList)
        .filter(function(image) {
          return image.isDirty()
        })
        .map(function(image) {
          return image.getChanges()
        });
      return _changedImages;
    },
    _updateChangedImages: function() {
      var images = this.getChangedImages();

      var self = this;
      images.forEach(function(image) {
        self.$.manager.updateImage(image);
      });

      this.fire('images-updated');
    },
    /**
     * Called when the Delete confirmation modal is closed.
     * If the modal was confirmed, we will ask the manager to delete the image.
     *
     * @private
     */
    _dialogClosed: function(e) {
      if (e && e.detail && e.detail.confirmed) {
        this.$.manager.deleteImage(this.$.confirmation.getAttribute('img-id'));
      }
    },
    /**
     * Sorts the initial list of returned images by the image sortOrder property.
     * @private
     */
    _sort: function(a, b) {
      if (a.sortOrder > b.sortOrder) {
        return 1;
      }
      if (a.sortOrder < b.sortOrder) {
        return -1;
      }
      return 0;
    },
    /**
     * Method gets called after a ll-property-image-drag event is raised
     * @param {Object} data
     * @param {string} item - The item that is moving
     * @param {string} target - The drop target. We will move BEFORE this item.
     * @private
     */
    _dragDropped: function(data) {

      var _item;
      var _target;

      var _imageNodeList = this.querySelectorAll('ll-property-image');
      Array.prototype.slice.call(_imageNodeList)
        .forEach(function(item) {

          item.resetDropStyles();

          if (item.id === data.detail.item) {
            _item = item;
          } else if (item.id == data.detail.target) {
            _target = item;
          }
        });

      Polymer.dom(this.$.row).insertBefore(_item, _target);

      this._updateSortValues();
    },
    /**
     * Method to iterate of child ll-property-images and call setSortOrder.
     * Triggered after a drag/drop event
     * @private
     */
    _updateSortValues: function() {
      var _imageNodeList = this.querySelectorAll('ll-property-image');
      var self = this;
      Array.prototype.slice.call(_imageNodeList)
        .forEach(function(item, index) {
          if(item.sortOrder !== index) {
            var tempImg = {
              imgId : item.id,
              sortOrder: index
            };

            self.$.manager.updateImage(tempImg);
            item.setSortOrder(index);
          }
        });
    },
    /**
     * Handles the ll-property-uploader `upload` event
     * @private
     */
    _handleUpload: function(data) {
      var upload = data.detail;
      this.$.manager.addImage(data.detail, this._images.length);

      this.$.uploader.reset();
    },
    /**
     * This method is called when the event 'images-received' is raised from the Manager.
     * It will contain the array of the images that needs to be displayed.
     * @param {Object} data
     * @param {Array} data.detail - The Array of Images
     * @private
     */
    _imagesReceived: function(data) {
      if (!data || !data.detail) {
        return;
      }

      this._images = data.detail.map(function(image) {
        return {
          _id: image._id,
          fileName: image.fileName,
          title: image.title,
          description: image.description,
          isDefault: image.isDefault || false,
          url: image.url,
          sortOrder: image.order || 0,
          tags: image.categories || []
        }
      });
      this.fire('images-loaded');
    },
    /**
     * This method is called when the event 'image-added' is raised from the Manager.
     * It will contain an object with the data for the image that needs to be added.
     * @param {Object} data
     * @param {Object} data.detail
     * @private
     */
    _imageAdded: function(data) {
      var image = data.detail;

      this.push('_images', {
        _id: image._id,
        fileName: image.fileName,
        title: image.title,
        description: image.description,
        isDefault: image.isDefault || false,
        tags: image.tags || [],
        url: image.url,
        sortOrder: this._images.length
      });
    },
    /**
     * This method is called when the event 'image-removed' is raised from the Manger.
     * It will contain the id for the image to be removed from the _images Array.
     * @param {object} data
     * @param {object} data.detail - Will contain the id of the Image
     * @private
     */
    _imageRemoved: function(data) {
      var img = _.findIndex(this._images, { _id: data.detail });
      this.splice('_images', img, 1);
    },
    /**
     * This metho is called when the event 'image-updated' is raised from the manager.
     * It will contain the id of the image on data.detail'.
     * We need to find the Image by Id, and reset its Dirty status.
     * @param data
     * @private
     */
    _imageUpdated: function(data) {
      //We need to get the NodeList object, convert it to an array (so we can loop)
      var _imageNodeList = this.querySelectorAll('ll-property-image');

      Array.prototype.slice.call(_imageNodeList)
        .filter(function(image) {
          return image.id == data.detail
        })
        .forEach(function(image) {
          image.resetDirtyStatus()
        });
    }

  });

</script>
